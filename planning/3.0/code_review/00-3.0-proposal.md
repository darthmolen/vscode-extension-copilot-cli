# Copilot CLI Extension 3.0 Proposal

**Date:** 2026-02-12
**Author:** Deep research session (Claude Code)
**Status:** Draft for review

---

## Context

The 3.0 refactor has successfully broken the 2.x monolith into components and established an event-driven architecture. This proposal addresses remaining architectural issues and identifies opportunities from VS Code's January 2026 API updates to make the extension a first-class VS Code AI experience.

### Supporting Documents
- [01-codebase-audit.md](01-codebase-audit.md) — Full audit with issues by severity
- [02-vscode-api-opportunities.md](02-vscode-api-opportunities.md) — API analysis and adoption strategy
- [03-event-architecture-recommendations.md](03-event-architecture-recommendations.md) — Event system redesign
- [04-scrolling-recommendations.md](04-scrolling-recommendations.md) — MessageDisplay scrolling fixes

---

## The Three Big Moves

### Move 1: Fix the Foundation (Event Lifecycle)

The current event system has memory leaks, race conditions, and tight coupling. These need fixing regardless of what APIs we adopt.

**Changes:**
| What | Why | Files |
|------|-----|-------|
| Split `onMessage` into granular `onDid*` events | Eliminates 87-line switch, makes event contract explicit | `sdkSessionManager.ts`, `extension.ts` |
| Convert `ChatPanelProvider` from static to instance | Fixes handler-set leaks, enables proper disposal | `chatViewProvider.ts`, `extension.ts` |
| Add `DisposableStore` + `MutableDisposable` utilities | Foundation for all lifecycle management | New `utilities.ts` (~30 lines) |
| Implement `EventRelay` for session switching | Eliminates 4 manual resubscription sites | `sdkSessionManager.ts` |
| Add `BufferedEmitter` for startup race | Prevents dropped events before webview ready | New utility, `extension.ts` |
| Capture all RPC handler disposables | Fixes leaked subscriptions on recreation | `chatViewProvider.ts` |
| Add error boundaries to event handlers | Prevents silent failures | `ExtensionRpcRouter.ts`, `sdkSessionManager.ts` |

**Effort:** Medium. Mostly restructuring existing code with better lifecycle management.

### Move 2: Fix the Scrolling (Immediate)

The MessageDisplay scrolling has race conditions in the `isProgrammaticScroll` flag, false positives from observing `<main>` instead of the messages container, and heavy logging in hot paths.

**Immediate fixes (keep current architecture):**
1. Replace `setTimeout(fn, 0)` with `requestAnimationFrame` in `scrollToBottom()`
2. Switch from ResizeObserver on `<main>` to MutationObserver on `messagesContainer`
3. Remove/gate 12+ console.log statements in scroll paths
4. Consolidate duplicate `clear()`/`clearMessages()` methods
5. Remove local `escapeHtml` reimplementation

**Effort:** Low. Direct bug fixes, no architectural change.

### Move 3: Adopt VS Code Chat APIs (Strategic)

This is the biggest opportunity. VS Code's Chat Participant API (finalized) eliminates the scrolling problem entirely and gives native rendering, streaming, follow-ups, and feedback for free.

**Phased adoption:**

#### Phase A: Sidebar View
Convert from `WebviewPanel` to `WebviewViewProvider`. Already planned in `sidebar-view-refactor.md`.
- Activity bar icon
- Draggable to secondary sidebar
- Better UX as an AI tool

#### Phase B: Chat Participant (Parallel Entry Point)
Register as `@copilot-cli` in VS Code's native chat panel. Keep the sidebar view as well.
- `stream.markdown()` handles all scrolling
- `stream.progress()` replaces thinking indicator
- `stream.button()` for interactive actions
- Follow-up provider for suggested next prompts
- Feedback tracking built in

This is NOT a replacement for the sidebar — it's a complementary entry point. Quick interactions go through `@copilot-cli` in the chat panel. Full-featured sessions go through the sidebar.

#### Phase C: Chat Output Renderers (Proposed API)
Register custom renderers for tool execution visualizations, diffs, and plan mode.
- Requires engine bump to `^1.109.0`
- Requires `enabledApiProposals: ["chatOutputRenderer"]`
- Reuse existing ToolExecution component HTML inside chat bubbles
- Development builds only until API stabilizes

#### Phase D: Session Controller (Proposed API)
Replace custom SessionToolbar with native VS Code session management.
- Push-based model aligns with event architecture
- Native session browsing, archiving, status tracking

---

## Dependency Graph

```
Move 1 (Foundation) ──→ Move 3 Phase A (Sidebar)
         │                      │
         │                      ↓
         ├──→ Move 3 Phase B (Chat Participant)
         │                      │
         │                      ↓
         └──→ Move 3 Phase C (Output Renderer)
                                │
                                ↓
                   Move 3 Phase D (Session Controller)

Move 2 (Scroll fixes) ──→ standalone, do first
```

Move 2 is independent and should be done immediately.
Move 1 is prerequisite for Move 3 (clean lifecycle required).
Move 3 phases are sequential but each is independently shippable.

---

## What NOT to Do

1. **Don't add external event libraries** (RxJS, ts-bus, etc.) — VS Code's native `EventEmitter<T>` is sufficient, and third-party libraries don't integrate with the `Disposable` lifecycle.

2. **Don't rewrite the webview frontend** — The component architecture is sound. The EventBus, BEM CSS, and component hierarchy work well. Fix the lifecycle issues on the extension host side.

3. **Don't abandon the custom webview entirely** — The Chat Participant API is powerful but doesn't support everything you have (plan mode UI, acceptance controls, custom session management, attachment drag/drop). Keep both entry points.

4. **Don't use `chatOutputRenderer` in production yet** — It's proposed, not finalized. Use it in development builds to validate the pattern, but don't ship with `enabledApiProposals`.

---

## Proposed Implementation Order

### Sprint 1: Foundation Fixes
1. Create `DisposableStore`, `MutableDisposable`, `toDisposable` utilities
2. Fix MessageDisplay scrolling bugs (Move 2, all 5 fixes)
3. Convert `ChatPanelProvider` to instance-based with `DisposableStore`
4. Capture RPC handler disposables

### Sprint 2: Event System Upgrade
5. Split `SDKSessionManager.onMessage` into granular `onDid*` events
6. Refactor `extension.ts` from switch to per-event subscriptions
7. Implement `EventRelay` for session switching
8. Replace `sessionUnsubscribe` with `MutableDisposable`
9. Add `BufferedEmitter` for startup race condition

### Sprint 3: Sidebar View
10. Convert from `WebviewPanel` to `WebviewViewProvider`
11. Add viewsContainers and views contributions to package.json
12. Create activity bar icon
13. Test drag to secondary sidebar
14. Update all commands to work with sidebar view

### Sprint 4: Chat Participant Integration
15. Register `@copilot-cli` as Chat Participant
16. Implement handler bridging to `SDKSessionManager`
17. Add streaming response loop with `stream.markdown()`
18. Add slash commands (/plan, /session)
19. Add follow-up provider
20. Add feedback tracking

### Sprint 5: Rich Rendering (Development Builds)
21. Bump engine to `^1.109.0`
22. Register Chat Output Renderer for tool executions
23. Reuse ToolExecution HTML in chat bubble webviews
24. Register Session Controller for native session management
25. Test proposed APIs in VS Code Insiders

---

## Risk Assessment

| Risk | Probability | Mitigation |
|------|------------|------------|
| Chat Participant API changes before 3.0 ships | Low | API is finalized since mid-2024 |
| Chat Output Renderer never stabilizes | Medium | Keep custom webview as fallback, don't depend on proposed APIs |
| Sidebar view breaks existing user workflows | Low | Clean cut is fine — sidebar is objectively better than editor tab |
| Event system refactor introduces regressions | Medium | 90+ existing tests provide safety net; add DisposableStore tests |
| SDK events change format in future SDK versions | Medium | Granular events create a boundary layer that absorbs SDK changes |

---

## Success Metrics

- [ ] Zero memory leaks from event handler subscriptions
- [ ] No dropped messages on startup (buffering works)
- [ ] Scrolling "just works" — no user-reported scroll bugs
- [ ] Extension appears in activity bar with sidebar support
- [ ] `@copilot-cli` works in VS Code's native chat panel
- [ ] All 90+ existing tests pass after refactor
- [ ] Session management integrates with native VS Code sessions
- [ ] Tool executions render inside chat response bubbles (dev builds)

---

## Open Questions for Review

1. **Should the Chat Participant be the primary experience or the sidebar?** The sidebar gives full control; the participant gives native UX. Recommendation: sidebar primary, participant as complementary.

2. **When to bump the engine to 1.109?** The proposed APIs are valuable but restrict to Insiders. Could maintain two branches or wait for stabilization.

3. **Should the EventBus on the webview side also be refactored?** It works well for component communication. The issues are all on the extension host side. Recommendation: leave it alone.

4. **Session management: custom vs native?** The Session Controller API is push-based which fits well, but it's proposed. Recommendation: keep custom for now, add native when API stabilizes.
