# vscode-extension-copilot-cli 3.0 architecture plan

## Goals

- **Clarify boundaries** between extension host (backend) and webview (frontend).
- **Modularize UI** so it can evolve independently (e.g., MCP UI, new panels).
- **Add a WebviewViewProvider** - secondary bar support instead of a tab window.
- **Stabilize messaging** with a typed RPC layer.
- **Prepare for 3.0 features** like MCP UI and richer developer-focused workflows.

---

## High-level architecture

### Extension host (backend)

- **Responsibilities:**
  - Register VS Code commands.
  - Manage sessions and state related to:
    - Copilot CLI server mode.
    - Copilot SDK agent runtime.
    - Plan mode.
    - Tool permissions.
  - Perform workspace operations (read/write files, apply edits).
  - Handle all communication with:
    - Copilot CLI.
    - Copilot SDK.
    - MCP servers.
  - Expose a clean RPC surface to the webview.

- **Non-responsibilities:**
  - No rendering logic.
  - No UI layout decisions.
  - No direct user interaction beyond commands and notifications.

### Webview (frontend)

- **Responsibilities:**
  - Render chat UI, diffs, plan mode, and (later) MCP UI.
  - Maintain all UI state:
    - Active session.
    - Message history.
    - Streaming deltas.
    - Inline diffs.
    - Plan mode state.
    - Tool execution logs.
  - Send user intents to the backend via typed messages.
  - Decide how to visually represent backend events.

- **Non-responsibilities:**
  - No direct filesystem access.
  - No direct Copilot SDK or CLI calls.
  - No business logic beyond UI behavior.

---

## Proposed folder structure

```text
src/
  extension/
    activate.ts
    commands/
      index.ts
      registerCommands.ts
    services/
      SessionService.ts
      CopilotService.ts
      CliServerService.ts
      ToolPermissionService.ts
      PlanModeService.ts
      McpService.ts
    rpc/
      ExtensionRpcRouter.ts
  webview/
    app/
      components/
        Chat/
        Diff/
        PlanMode/
        Toolbar/
        SessionSelector/
      state/
        store.ts
        sessionState.ts
        uiState.ts
      rpc/
        WebviewRpcClient.ts
        messageHandlers.ts
      utils/
        diffParser.ts
        formatting.ts
    main.ts
    index.html
    styles.css
  shared/
    messages.ts
    models.ts
    types.ts

---

## Implementation phases

See detailed phase documentation in `planning/3.0/phases/`:
- **Phase 0:** Setup and dependencies
- **Phase 1:** Extract HTML to separate files
- **Phase 2:** Implement typed RPC layer
- **Phase 3:** Extract backend services
- **Phase 4:** Componentize UI
- **Phase 5:** CLI-only command support (terminal + in-chat refresh)
- **Phase 6:** MCP UI preparation

---

## üìä Implementation Status (Updated 2026-02-09)

### ‚úÖ Completed Phases

#### Phase 2: Typed RPC Layer
**Status**: ‚úÖ Complete (v2.2.0)
- Implemented WebviewRpcClient in webview
- Message type safety with TypeScript
- Clean separation between extension and webview communication
- All messages properly typed and documented

#### Phase 3: Backend Services Extraction
**Status**: üîÑ In Progress (40% complete)

**Completed Sub-Phases**:
- ‚úÖ **Phase 0** - PlanModeToolsService Enhancement (Configuration Abstraction)
  - Date: 2026-02-09
  - Code reduction: -119 lines from sdkSessionManager.ts
  - 9 unit tests added
  - Commits: `ab005c5`, `1f2cf42`
  - Summary: [`3.0-phase0-work-summary.md`](./3.0-phase0-work-summary.md)

- ‚úÖ **Phase 0.1** - Critical Bug Fixes
  - Date: 2026-02-09
  - Fixed: filediff tool crash (payload.data handling)
  - Fixed: View Plan button visibility (workspace init)
  - 7 unit tests added (3 + 4)
  - Commits: `be7457a`, `2bf31db`, `04c7b5b`
  - Summary: [`3.0-phase0.1-work-summary.md`](./3.0-phase0.1-work-summary.md)

**Existing Services** (extracted in v2.2+):
- ModelCapabilitiesService - Model info caching, attachment validation
- MCPConfigurationService - MCP server configuration management
- PlanModeToolsService - Plan mode tool implementations (enhanced in Phase 0)
- FileSnapshotService - File snapshot management
- MessageEnhancementService - Message formatting

**In Progress**:
- ‚è≥ **Phase 1** - ConfigurationService (not started)
- ‚è≥ **Phase 2** - SessionService (not started)
- ‚è≥ **Phase 3** - StartupService (not started)
- ‚è≥ **Phase 4** - CommandHandlerService (not started)
- ‚è≥ **Phase 5** - ActiveFileTrackerService (optional, not started)
- ‚è≥ **Phase 6** - Final Refactor - Organize all services in `src/extension/services/`

**Progress Metrics**:
- extension.ts: 879 lines (target: ~200 lines, 77% reduction needed)
- sdkSessionManager.ts: ~~1568~~ ‚Üí **1449 lines** (-119, target met!)
- chatViewProvider.ts: 539 lines (target: ~300 lines, 44% reduction needed)
- Services extracted: 5 existing + 1 enhanced = 6 total
- New tests: 16 (9 config + 7 bug fixes)

**Detailed Progress**: See [`3.0-plan-progress.md`](./3.0-plan-progress.md)

### ‚è≥ Pending Phases

#### Phase 1: Extract HTML to Separate Files
**Status**: Not started
- Extract inline HTML from TypeScript
- Separate files for HTML structure
- Prerequisite for Phase 4 (componentization)

#### Phase 4: Componentize UI
**Status**: Not started
- Break monolithic webview into components
- Component-based architecture
- Easier maintenance and testing

#### Phase 5: CLI-only Command Support
**Status**: Not started
- Terminal integration
- In-chat refresh capabilities
- Enhanced developer workflows

#### Phase 6: MCP UI Preparation
**Status**: Not started
- MCP server management UI
- Configuration interface
- Tool approval UI

---

## Current Focus

**Active Work**: Phase 3 - Backend Services Extraction
- Working through service-by-service extraction using TDD
- Configuration abstraction pattern established
- Target: Complete all 6 service extractions + final organization

**Next Up**: Phase 1 - ConfigurationService
- Extract configuration management from extension.ts
- ~50 lines reduction expected
- 6 unit tests planned
- Will follow same TDD pattern as Phase 0

**Branch**: `feature/3.0.0`  
**Commits Ready**: 7 commits (Phase 0 + Phase 0.1 + documentation)

---

## Success Criteria

### Phase 3 Complete When:
- ‚úÖ All services extracted and organized in `src/extension/services/`
- ‚úÖ extension.ts reduced to ~200 lines (currently 879)
- ‚úÖ sdkSessionManager.ts reduced to ~1450 lines (‚úÖ TARGET MET: 1449)
- ‚úÖ chatViewProvider.ts reduced to ~300 lines (currently 539)
- ‚úÖ 54+ unit tests covering all services
- ‚úÖ All existing functionality working
- ‚úÖ No regressions in integration tests

### Overall 3.0 Complete When:
- All 6 implementation phases complete
- Clean separation of concerns (backend/frontend)
- Typed RPC layer in use throughout
- Component-based UI architecture
- MCP UI foundation ready
- Comprehensive test coverage
- Documentation updated
