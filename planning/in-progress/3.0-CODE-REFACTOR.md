# vscode-extension-copilot-cli 3.0 architecture plan

## Goals

- **Clarify boundaries** between extension host (backend) and webview (frontend).
- **Modularize UI** so it can evolve independently (e.g., MCP UI, new panels).
- **Add a WebviewViewProvider** - secondary bar support instead of a tab window.
- **Stabilize messaging** with a typed RPC layer.
- **Prepare for 3.0 features** like MCP UI and richer developer-focused workflows.

---

## High-level architecture

### Extension host (backend)

- **Responsibilities:**
  - Register VS Code commands.
  - Manage sessions and state related to:
    - Copilot CLI server mode.
    - Copilot SDK agent runtime.
    - Plan mode.
    - Tool permissions.
  - Perform workspace operations (read/write files, apply edits).
  - Handle all communication with:
    - Copilot CLI.
    - Copilot SDK.
    - MCP servers.
  - Expose a clean RPC surface to the webview.

- **Non-responsibilities:**
  - No rendering logic.
  - No UI layout decisions.
  - No direct user interaction beyond commands and notifications.

### Webview (frontend)

- **Responsibilities:**
  - Render chat UI, diffs, plan mode, and (later) MCP UI.
  - Maintain all UI state:
    - Active session.
    - Message history.
    - Streaming deltas.
    - Inline diffs.
    - Plan mode state.
    - Tool execution logs.
  - Send user intents to the backend via typed messages.
  - Decide how to visually represent backend events.

- **Non-responsibilities:**
  - No direct filesystem access.
  - No direct Copilot SDK or CLI calls.
  - No business logic beyond UI behavior.

---

## Proposed folder structure

```text
src/
  extension/
    activate.ts
    commands/
      index.ts
      registerCommands.ts
    services/
      SessionService.ts
      CopilotService.ts
      CliServerService.ts
      ToolPermissionService.ts
      PlanModeService.ts
      McpService.ts
    rpc/
      ExtensionRpcRouter.ts
  webview/
    app/
      components/
        Chat/
        Diff/
        PlanMode/
        Toolbar/
        SessionSelector/
      state/
        store.ts
        sessionState.ts
        uiState.ts
      rpc/
        WebviewRpcClient.ts
        messageHandlers.ts
      utils/
        diffParser.ts
        formatting.ts
    main.ts
    index.html
    styles.css
  shared/
    messages.ts
    models.ts
    types.ts

---

## Implementation Phases

| Phase | Name | Status |
|-------|------|--------|
| Phase 0 | Setup and Dependencies | ‚úÖ Complete |
| Phase 1 | Extract HTML to Separate Files | ‚úÖ Complete |
| Phase 2 | Typed RPC Layer | ‚úÖ Complete |
| Phase 3 | Backend Services Extraction | üîÑ In Progress (40%) |
| Phase 4 | Componentize UI | ‚è≥ Not Started |
| Phase 5 | CLI-only Command Support | ‚è≥ Not Started |
| Phase 6 | MCP UI Preparation | ‚è≥ Not Started |

**Detailed Progress & Documentation**: See [`3.0-plan-progress.md`](./3.0-plan-progress.md)

---

## Success Criteria
