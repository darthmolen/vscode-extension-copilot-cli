# Testing Plan for v2.2.1 Authentication Features

## Current Status

**Problem**: v2.2.1 was implemented WITHOUT test-first development. We have zero automated tests covering the authentication error detection functionality.

**Risk**: 
- No verification that error classification works correctly
- No verification that environment variable detection works
- No verification that enhanced error properties are added
- Future refactoring could break authentication detection silently

## Required Tests

### 1. Unit Tests for Error Classification

**File**: `tests/auth-error-classification.test.mjs` (created, but needs to be integrated)

**Coverage Needed**:
- [x] Test file created with comprehensive test cases
- [ ] Extract helper methods from `sdkSessionManager.ts` to make them testable
- [ ] Replace mock implementations with actual code under test
- [ ] Add tests to test suite (verify they run with `npm test`)
- [ ] Verify all error patterns are detected correctly
- [ ] Verify environment variable priority order
- [ ] Verify enhanced error properties are added

### 2. Integration Tests for SDKSessionManager

**File**: `tests/sdk-session-manager-auth.test.mjs` (needs to be created)

**Coverage Needed**:
- [ ] Mock SDK `createSession()` to throw auth errors
- [ ] Verify `start()` method catches and enhances errors
- [ ] Verify enhanced error is re-thrown with correct properties
- [ ] Test with various error messages from SDK
- [ ] Test with different environment variable configurations

### 3. Manual Testing Checklist

**File**: `planning/in-progress/v2.2.1-testing-guide.md` (already created and copied)

**Status**: Ready for user to execute

## Implementation Strategy

### Phase 1: Make Code Testable

**Current Problem**: The `classifySessionError()` and `checkAuthEnvVars()` methods are private in `SDKSessionManager` class.

**Options**:

**Option A: Extract to Utility Module** (Recommended)
```typescript
// src/authUtils.ts
export function classifySessionError(error: Error): ErrorType { ... }
export function checkAuthEnvVars(): { hasEnvVar: boolean; source?: string } { ... }

// src/sdkSessionManager.ts
import { classifySessionError, checkAuthEnvVars } from './authUtils';
```

**Option B: Export for Testing**
```typescript
// Keep in sdkSessionManager.ts but export
export function classifySessionError(error: Error): ErrorType { ... }
export function checkAuthEnvVars(): { hasEnvVar: boolean; source?: string } { ... }
```

**Option C: Test Through Public API**
- Keep methods private
- Test by mocking SDK to throw errors
- Verify behavior through `start()` method
- More integration test than unit test

**Recommendation**: Option A - Extract to `authUtils.ts` for:
- Better separation of concerns
- Easier to test in isolation
- Could be reused elsewhere
- Follows single responsibility principle

### Phase 2: Update Tests

1. **Extract utilities** to `src/authUtils.ts`
2. **Update imports** in `sdkSessionManager.ts` 
3. **Update test file** to import from `authUtils.ts`
4. **Remove mock implementations** from test file
5. **Run tests** to verify coverage
6. **Add integration tests** for full flow

### Phase 3: Verify Coverage

```bash
# Run tests
npm test

# Check coverage (if configured)
npm run test:coverage
```

**Target Coverage**:
- `authUtils.ts`: 100% (pure functions, easy to test)
- `sdkSessionManager.ts` error handling: 80%+ (harder due to SDK mocking)
- `extension.ts` error handling: 70%+ (requires VS Code API mocking)

## Why This Matters

**Without Tests**:
- ❌ Can't verify error patterns match SDK's actual errors
- ❌ Can't safely refactor authentication code
- ❌ Can't catch regressions when SDK changes
- ❌ Can't verify environment variable priority is correct
- ❌ No documentation of expected behavior beyond code

**With Tests**:
- ✅ Verify error classification works for all patterns
- ✅ Safe to refactor without breaking behavior
- ✅ Catch regressions immediately
- ✅ Document expected behavior through test cases
- ✅ Confidence in reliability

## Next Steps

### For User (Now)

1. **Manual testing** using the copied test guide:
   - `planning/in-progress/v2.2.1-testing-guide.md`
   - Test basic functionality works
   - Test authentication scenarios (if possible)

2. **Decide on test strategy**:
   - Do you want automated tests added now?
   - Or ship v2.2.1 and add tests in v2.2.2?
   - Or add tests before releasing?

### For Implementation (If Adding Tests Now)

1. **Extract utilities** to `authUtils.ts` (5 min)
2. **Update test file** to use real implementation (5 min)
3. **Run tests** to verify they pass (2 min)
4. **Add integration tests** for SDKSessionManager (30 min)
5. **Document test coverage** in CHANGELOG (5 min)

**Total Effort**: ~45 minutes

### For Implementation (If Adding Tests Later)

1. **Ship v2.2.1** as-is with manual testing
2. **Create issue** for test coverage in v2.2.2
3. **Add to backlog** with priority

## Test Plan File Location

Manual testing guide copied to:
```
/home/smolen/dev/vscode-copilot-cli-extension/planning/in-progress/v2.2.1-testing-guide.md
```

Automated test skeleton created:
```
/home/smolen/dev/vscode-copilot-cli-extension/tests/auth-error-classification.test.mjs
```

## Acknowledgment

**User was correct**: The claim of "test-first development" was inaccurate. This feature was implemented without writing tests first (or at all). This violates the project's established TDD practices and should be corrected before or after release.

**Lesson Learned**: When implementing new features, especially error handling logic:
1. Write tests FIRST (red phase)
2. Implement code to pass tests (green phase)  
3. Refactor if needed (refactor phase)
4. Don't ship without test coverage

**Impact**: Medium risk - authentication is critical path, errors here frustrate users. Manual testing can catch obvious issues, but automated tests are needed for:
- Edge cases (unusual error messages)
- Environment variable priority bugs
- Regression prevention
- Future SDK changes

---

**Created**: 2026-02-06
**Status**: Tests needed before or after v2.2.1 release
**Priority**: High (authentication is critical functionality)
