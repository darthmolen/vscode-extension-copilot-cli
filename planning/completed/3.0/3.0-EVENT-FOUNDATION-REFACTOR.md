# 3.0 Event Foundation Refactor — Complete

This document combines the three planning docs that tracked the Phase 3→4 detour: when backend service extraction (Phase 3) uncovered the event lifecycle morass that became the Foundation Fix (Phase 4).

**Origin docs**: `3.0-CODE-REFACTOR.md`, `3.0-plan-progress.md`, `phase-3-extract-services.md`

---

## 3.0 Architecture Vision

### Goals

- Clarify boundaries between extension host (backend) and webview (frontend)
- Modularize UI so it can evolve independently
- Add a WebviewViewProvider — secondary sidebar support
- Stabilize messaging with a typed RPC layer
- Prepare for 3.0 features like MCP UI and richer developer-focused workflows

### Phase Status at Completion of Foundation Fix

| Phase | Name | Status |
|-------|------|--------|
| Phase 0 | Setup and Dependencies | COMPLETE |
| Phase 1 | Extract HTML to Separate Files | COMPLETE |
| Phase 2 | Typed RPC Layer | COMPLETE |
| Phase 3 | Backend Services Extraction | Paused at 40% — see Part 2 |
| Phase 4 | Foundation Fix (event lifecycle, scrolling, sidebar) | COMPLETE |
| Phase 5 | CLI-only Command Support | Not Started |
| Phase 6 | MCP UI Preparation | Not Started |

---

## Phase 3: Service Extraction (Completed Work)

### 5 Services Already Extracted (v2.2+)

1. **ModelCapabilitiesService** (`src/modelCapabilitiesService.ts`) — Model info caching, attachment validation
2. **MCPConfigurationService** (`src/mcpConfigurationService.ts`) — MCP server configuration management
3. **PlanModeToolsService** (`src/planModeToolsService.ts`) — Plan mode tool implementations + configuration abstraction
4. **FileSnapshotService** (`src/fileSnapshotService.ts`) — File snapshot management
5. **MessageEnhancementService** (`src/messageEnhancementService.ts`) — Message formatting

### Phase 0: PlanModeToolsService Enhancement (COMPLETE)

Added configuration abstraction methods:
- `getAvailableToolNames()` — returns 11 tool names (6 custom + 5 SDK)
- `getSystemPrompt(workSessionId)` — generates plan mode system prompt
- Removed 119 lines of hard-coded config from sdkSessionManager.ts
- 9 new unit tests

### Phase 0.1: Critical Bug Fixes (COMPLETE)

- Fixed filediff tool crash (payload.data handling)
- Fixed View Plan button visibility (workspace path init)
- 7 new unit tests

### Phase 0.2: Diff Button RPC Bug Fix (COMPLETE)

- Root cause: RPC layer only forwarded `available: boolean`, dropping toolCallId/URIs/title
- Updated `DiffAvailablePayload` interface with all required fields
- 5 new unit tests

---

## What Triggered the Foundation Fix Detour

During Phase 3 service extraction, we discovered critical event lifecycle issues:
- Static ChatPanelProvider with no disposal → memory leaks
- Startup race condition → dropped messages
- Monolithic 87-line switch statement for message handling
- Manual session unsubscribe outside disposable chain

This became the "Foundation Fix" (3.0-FOUNDATION-FIX-PLUS), which addressed:
- Phase 0: JSDOM test infrastructure
- Phase 1: BufferedEmitter + Error Boundaries
- Phase 2: Scrolling fixes (MessageDisplay)
- Phase 3: Sidebar migration (WebviewPanel → WebviewViewProvider)
- Phase 4: Test directory reorganization
- Phase 5: Pre-existing test failure cleanup

**Result**: 662 tests passing, 0 failing. Sidebar working. Event lifecycle sound.

---

## Remaining Phase 3 Work (Carried to Part 2)

Services still to extract from `extension.ts`:
1. **ConfigurationService** — centralized config management (~50 lines)
2. **SessionService** — session lifecycle management (~200 lines)
3. **StartupService** — extension/session initialization (~140 lines)
4. **CommandHandlerService** — command registration and orchestration (~200 lines)
5. **ActiveFileTrackerService** — active file tracking (~40 lines, optional)
6. **Final Refactor** — move all services to `src/extension/services/`

### Services Evaluated and Rejected

- **CopilotService** — SDKSessionManager already serves this purpose
- **CliServerService** — not applicable (SDK mode, not CLI server)
- **ToolPermissionService** — no tool approval UI yet (YAGNI)
- **PlanModeService** — enhanced PlanModeToolsService instead

---

## Target Metrics (Original)

| File | Before | Target | Current |
|------|--------|--------|---------|
| extension.ts | 879 lines | ~200 lines | ~879 lines (not yet extracted) |
| sdkSessionManager.ts | 1568 lines | ~1450 lines | ~1449 lines (TARGET MET) |
| chatViewProvider.ts | 539 lines | ~300 lines | Rewritten for sidebar |

---

## Key Architecture Decisions

- **MutableDisposable over EventRelay** — granular emitters serve as implicit relay; EventRelay added complexity without benefit
- **Configuration abstraction** — services own their config, not hard-coded in orchestrators
- **WebviewViewProvider** — sidebar is objectively better UX than editor tabs
- **BufferedEmitter** — zero vscode deps, structural interface compatibility for testability
