# 3.0 Code Refactor — Part 2: Backend Service Extraction

**Date**: 2026-02-13
**Status**: Complete
**Predecessor**: `planning/completed/3.0/3.0-EVENT-FOUNDATION-REFACTOR.md`

---

## Context

The 3.0 refactor paused Phase 3 (backend service extraction) at ~40% to fix the event lifecycle morass (Phase 4 / Foundation Fix). That detour is now complete:
- Event lifecycle: sound (BufferedEmitter, MutableDisposable, error boundaries)
- Sidebar migration: complete (WebviewViewProvider)
- Test infrastructure: solid (662 passing, 0 failing, organized directory)

Time to resume Phase 3.

---

## Current State

### Source File Inventory

| File | Lines | Role | Extraction Target |
|------|-------|------|-------------------|
| `extension.ts` | 915 | God object: commands, startup, session wiring, active file | ~200 |
| `sdkSessionManager.ts` | 1391 | SDK orchestration + plan mode + session lifecycle | ~1391 (target met) |
| `chatViewProvider.ts` | 412 | Sidebar webview + RPC routing | ~300 |
| `ExtensionRpcRouter.ts` | 516 | RPC message routing | Keep as-is |

### Already Extracted Services (5)

| Service | File | Lines |
|---------|------|-------|
| ModelCapabilitiesService | `src/modelCapabilitiesService.ts` | 322 |
| PlanModeToolsService | `src/planModeToolsService.ts` | 606 |
| MessageEnhancementService | `src/messageEnhancementService.ts` | 169 |
| FileSnapshotService | `src/fileSnapshotService.ts` | 165 |
| MCPConfigurationService | `src/mcpConfigurationService.ts` | 73 |

### Supporting Files

| File | Lines | Role |
|------|-------|------|
| `authUtils.ts` | 252 | Auth error handling, token validation |
| `sessionUtils.ts` | 168 | Session discovery, history loading |
| `backendState.ts` | 145 | Shared in-memory state |
| `logger.ts` | 71 | Logging utility |
| `utilities/disposable.ts` | 49 | DisposableStore, MutableDisposable |
| `utilities/bufferedEmitter.ts` | 80 | Race-safe event emitter |
| `shared/messages.ts` | 429 | RPC message types |
| `shared/models.ts` | 86 | Shared model types |

---

## Phase 3 Remaining: Service Extraction from extension.ts

**Goal**: Reduce `extension.ts` from 915 lines to ~200 (thin orchestrator that wires services and registers commands).

### Service 1: ConfigurationService

**Extract from**: Scattered `vscode.workspace.getConfiguration('copilotCLI')` calls
**Lines saved**: ~50
**Priority**: HIGH (other services depend on it)

Centralizes all configuration reads:
- `getCLIConfig()` — full config object with YOLO overrides
- Individual getters: model, planModel, resumeLastSession, filterSessionsByFolder, etc.
- `onConfigurationChanged` event

### Service 2: SessionService

**Extract from**: `extension.ts` session management logic
**Lines saved**: ~200
**Priority**: HIGH (core domain concern)

Consolidates session lifecycle:
- `determineSessionToResume()` — folder filtering, most recent session
- `updateSessionsList()` — format labels, populate dropdown
- `formatSessionLabel()` — extract title from plan.md
- `loadSessionHistory()` — parse events.jsonl

Note: `sessionUtils.ts` (168 lines) already has some of this logic and could be absorbed.

### Service 3: StartupService

**Extract from**: `startCLISession()` in extension.ts (~244 lines)
**Lines saved**: ~140
**Priority**: MEDIUM

Session initialization and error recovery:
- Start new session vs. resume
- Auth error handling (Scenario 1 & 2 from authUtils)
- Session expired recovery dialog
- Status bar setup

### Service 4: CommandHandlerService

**Extract from**: `activate()` command registrations in extension.ts
**Lines saved**: ~200
**Priority**: MEDIUM

All command handlers:
- openChat, startChat, newSession, switchSession
- stopChat, refreshPanel, viewDiff
- togglePlanMode, acceptPlan, rejectPlan

### Service 5: ActiveFileTrackerService (Optional)

**Extract from**: `updateActiveFile()` in extension.ts (~40 lines)
**Lines saved**: ~40
**Priority**: LOW

Simple but worth isolating:
- Path normalization to workspace-relative
- Configuration respect (includeActiveFile setting)
- Editor state tracking

---

## Phase 3 Final: Directory Organization

Move all services to `src/extension/services/`:

```
src/
  extension/
    services/
      ConfigurationService.ts     (NEW)
      SessionService.ts           (NEW)
      StartupService.ts           (NEW)
      CommandHandlerService.ts    (NEW)
      ActiveFileTrackerService.ts (NEW, optional)
      ModelCapabilitiesService.ts (MOVED from src/)
      MCPConfigurationService.ts  (MOVED from src/)
      PlanModeToolsService.ts     (MOVED from src/)
      FileSnapshotService.ts      (MOVED from src/)
      MessageEnhancementService.ts(MOVED from src/)
      index.ts                    (barrel export)
    rpc/
      ExtensionRpcRouter.ts       (already here)
      index.ts                    (already here)
  utilities/
    disposable.ts                 (already here)
    bufferedEmitter.ts            (already here)
  shared/
    messages.ts                   (already here)
    models.ts                     (already here)
    index.ts                      (already here)
  extension.ts                    (~200 lines: activate + wire services)
  chatViewProvider.ts             (~300 lines: webview + RPC only)
  sdkSessionManager.ts            (~1391 lines: SDK orchestration)
  backendState.ts                 (keep in src/ root — cross-cutting)
  logger.ts                       (keep in src/ root — cross-cutting)
  authUtils.ts                    (absorb into StartupService or keep)
  sessionUtils.ts                 (absorb into SessionService)
```

---

## Remaining 3.0 Scope (Beyond Phase 3)

### Phase 5: CLI Terminal Passthrough

When a user sends a / command we don't handle (or explicitly requests CLI mode), pop a VS Code terminal with the Copilot CLI pre-configured:
- Pass all values that started the SDK session (model, config, workspace)
- Include `--resume <currentSessionId>` to continue the conversation
- Show a message in the chat that we opened a terminal for them
- Simplified scope — not a full CLI integration, just a smart handoff

### Phase 6: Inline Diff Display

Show file diffs inline in tool message boxes (like Claude Code extension):
- Display changed lines with a few lines of context (simplified, not full unified diff)
- Render under the tool parameters in the tool execution UI
- Keep the existing "View Diff" button as a breakout to VS Code's full diff viewer
- Source data: `filediff` event already provides before/after content

### Backlog: MCP UI Preparation

Pushed to backlog — already exists at `planning/backlog/mcp-server-management-ui.md`

---

## Implementation Order

1. SessionService (biggest impact ~200 lines, absorbs sessionUtils)
2. StartupService (depends on SessionService, ~140 lines)
3. ConfigurationService (centralize scattered reads, ~50 lines)
4. CommandHandlerService (depends on all above, ~200 lines)
5. ActiveFileTrackerService (independent, optional, ~40 lines)
6. Directory reorganization (move existing 5 services, update all imports)
7. Phase 5: CLI terminal passthrough
8. Phase 6: Inline diff display

---

## TDD Approach (Per Service)

1. RED: Write tests for service interface
2. GREEN: Create service, extract logic from extension.ts
3. REFACTOR: Wire into extension.ts, remove old code
4. VERIFY: All 662+ tests pass, build compiles, manual test

---

## Success Criteria

- [ ] extension.ts under 200 lines — **721 lines** (down from 915, well-structured but not at target)
- [ ] chatViewProvider.ts under 300 lines — **412 lines** (unchanged, not yet addressed)
- [x] All services in `src/extension/services/` — **6 services**, all moved
- [x] Each service independently testable — SessionService has 23 unit tests
- [x] No circular dependencies — confirmed, clean `tsc` compile
- [x] 662+ tests still passing — **685 passing** (662 original + 23 new SessionService)
- [x] All features work unchanged — build + VSIX package verified

---

## Status Log

### 2026-02-13: Phase 3 Service Extraction + Directory Reorg

**Completed:**

1. **SessionService** (TDD, full RED/GREEN/REFACTOR cycle)
   - Created `src/extension/services/SessionService.ts` (222 lines)
   - 23 unit tests at `tests/unit/extension/session-service.test.js`
   - Absorbs logic from `sessionUtils.ts` + 4 functions from `extension.ts`
   - Decoupled API: takes explicit paths/config, no global state dependency
   - Wired into `extension.ts` and `sdkSessionManager.ts`

2. **Startup refactoring** (refactor step, no new behavior)
   - Split 250-line `startCLISession()` into 5 focused functions:
     - `startCLISession()` — 15-line orchestrator
     - `wireManagerEvents()` — 10 event subscriptions
     - `onSessionStarted()` — post-start state + UI setup
     - `handleStartupError()` / `handleExpiredTokenError()` / `handleNoAuthError()`

3. **Command handler extraction** (refactor step)
   - Split 365-line `activate()` into ~30-line orchestrator
   - `registerCommands()` — declarative command table
   - `registerChatProviderHandlers()` — message, abort, view plan
   - 10 individual `handle*()` functions

4. **Directory reorganization**
   - Moved 5 existing services from `src/` to `src/extension/services/`
   - Updated all import paths (source + tests)
   - Cleaned 19 stale `.js`/`.js.map` tsc artifacts from `src/`
   - Added `.gitignore` patterns to prevent reoccurrence
   - `npm run lint` now produces **0 warnings** (was 89)

**Final file inventory:**

| File | Lines | Change |
| --- | --- | --- |
| `extension.ts` | 721 | 915 to 721 (-194) |
| `sdkSessionManager.ts` | 1393 | ~unchanged |
| `chatViewProvider.ts` | 412 | unchanged |
| `src/extension/services/` | 6 files, 1557 lines | NEW directory |
| Tests | 685 passing, 0 fail | +23 new |

**Deferred:**

- ConfigurationService (~50 lines, low ROI for effort)
- ActiveFileTrackerService (~40 lines, optional)
- `sessionUtils.ts` deletion (integration test still imports it; remove during future cleanup)
- `extension.ts` → 200 line target (would require moving command handlers + startup to separate files, high coupling to module-level state makes this low value)
- `chatViewProvider.ts` → 300 line target (not yet started)

### 2026-02-13: Auto-Resume Fix (Bug from Phase 3 refactor)

**Bug**: After Developer Reload with sidebar open, CLI never auto-started. The `onDidBecomeReady` event fired but had no subscriber.

**Fix**: Added `onDidBecomeReady` handler in `registerChatProviderHandlers()`. Extracted shared `resumeAndStartSession()` to eliminate duplication with `handleOpenChat()`. Handler re-sends init to webview after loading history (first send was empty).

**Also investigated**: Client-side `UriError: Scheme contains illegal characters` — confirmed VS Code internal (their `FileSystemService` hitting a 23MB `.jsonl` session file). Not our bug.

**Remaining 3.0 scope** (separate planning docs):

- Phase 6: Inline diff display
- Phase 5: CLI terminal passthrough
