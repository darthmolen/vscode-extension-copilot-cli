# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Branding

Do not add "written by Claude Code", "generated by Claude", "Co-Authored-By: Claude", or any AI attribution text to code, comments, commit messages, documentation, or any other output. The extension is built with Claude but branded as the user's own work.

## Build & Test Commands

```bash
npm run compile          # Type-check + lint + esbuild bundle
npm run watch            # Continuous rebuild (esbuild + tsc in parallel)
npm run package          # Production build (minified)
npm test                 # All unit + integration tests (~710 tests, Mocha + Chai)
npm run test:unit        # Unit tests only
npm run test:integration # Integration tests only
npm run check-types      # TypeScript type checking only
npm run lint             # ESLint on src/ (TypeScript only)
./test-extension.sh      # Build → package VSIX → uninstall old → install new
```

Run single test file: `npx mocha tests/unit/components/some-test.test.js --timeout 10000`

Known baseline failure: `main.js size constraint` in integration tests is expected and not a regression.

## Debugging

**F5 works.** The extension bundle has no `navigator` references, and the launch.json is correctly configured for `extensionHost`. Press F5 to launch the Extension Development Host. The preLaunchTask runs `npm run compile` (type-check + lint + esbuild).

For a faster dev loop, use `npm run watch` in a terminal and the VSIX workflow: `./test-extension.sh` then reload the window (`Ctrl+Shift+P` → "Developer: Reload Window").

Logs go to the "Copilot CLI" Output Channel (`Ctrl+Shift+U`).

### Saved Log Files

The `tests/logs/server/` directory contains log files manually saved from the Output Channel for debugging and documentation. To read them as an AI agent:

1. Use `grep` to search for specific events (e.g., `grep -i "model switch\|error\|warn" tests/logs/server/model-change.log`)
2. Use `head`/`tail` via bash for large files (they can exceed the `view` tool's size limit)
3. Use `view` with `view_range` to read specific line ranges

Log format: `[LEVEL] TIMESTAMP Message` — levels are `INFO`, `DEBUG`, `WARN`, `ERROR`.

To save a new log: open the Output Channel (`Ctrl+Shift+U` → "Copilot CLI"), click the "..." menu → "Open Output in Editor", then save to `tests/logs/server/<descriptive-name>.log`.

## Architecture

This is a VS Code sidebar extension that wraps `@github/copilot-sdk` (backend-only, no UI) to provide a chat interface for GitHub Copilot CLI.

### Extension Host (TypeScript, `src/`)

- **extension.ts** — Orchestrator. Registers commands, creates ChatViewProvider, wires SDK events to webview.
- **sdkSessionManager.ts** — SDK session lifecycle. Creates/resumes CopilotClient sessions, streams messages, emits 10 granular events (onDidReceiveOutput, onDidStartTool, onDidProduceDiff, etc.).
- **chatViewProvider.ts** — Implements `WebviewViewProvider`. Manages ExtensionRpcRouter, slash command handlers, builds webview HTML. CSP config is at line ~494.
- **backendState.ts** — Singleton state store. Persists session data across webview recreations (sidebar hide/show).
- **src/extension/rpc/ExtensionRpcRouter.ts** — Type-safe RPC (18 send + 11 receive methods). Extension side of the message bridge.
- **src/extension/services/** — 7 extracted services: SessionService, InlineDiffService, FileSnapshotService, MCPConfigurationService, ModelCapabilitiesService, PlanModeToolsService, MessageEnhancementService.

### Webview (JavaScript ES modules, `src/webview/`)

The webview is plain JavaScript (not TypeScript, not bundled). Files are copied to `dist/` by esbuild.js.

- **main.js** — Bootstrap. Creates components, wires EventBus, registers RPC handlers.
- **app/rpc/WebviewRpcClient.js** — Webview-side RPC client using `acquireVsCodeApi()`.
- **app/state/EventBus.js** — Pub/sub for loose component coupling.
- **app/components/** — 9 components: MessageDisplay, ToolExecution, InputArea, SessionToolbar, AcceptanceControls, StatusBar, ActiveFileDisplay, PlanModeControls, SlashCommandPanel.
- **app/handlers/** — 5 handler modules for UI events, acceptance, messages, diffs, tool groups.

### Shared Types (`src/shared/`)

- **messages.ts** — 31 RPC message type definitions (the contract between extension and webview).
- **models.ts** — Domain types (Session, Message, ToolState, PlanModeStatus).

### Data Flow

```
User types message → InputArea → EventBus → main.js → WebviewRpcClient._send()
  → postMessage → ExtensionRpcRouter handler → SDKSessionManager.sendMessage()
  → Copilot SDK → CLI backend

CLI responds → SDK event → SDKSessionManager emitter
  → ChatViewProvider handler → ExtensionRpcRouter.send*()
  → postMessage → WebviewRpcClient handler → EventBus.emit() → Components update DOM
```

### Key Patterns

- **BufferedEmitter** (`src/utilities/bufferedEmitter.ts`): Queues events if webview isn't ready; replays on connect. Prevents lost messages during startup.
- **DisposableStore** (`src/utilities/disposable.ts`): Centralized cleanup for subscriptions.
- **Dual-session plan mode**: Work session + plan session. Plan session writes to work session's `plan.md`. Plan mode restricts tool access (no write/commit/install).

## Versioning (Semver)

- **Patch** (3.1.x): Bug fixes and minor changes. No new features, no new UI, no new APIs. Small behavior improvements (e.g., smarter fallback logic) that don't add capabilities are patch-level.
- **Minor** (3.x.0): New features, new capabilities, new UI elements. Image support, mermaid rendering, model switching — these are all minor bumps.
- **Major** (x.0.0): Breaking changes, architectural rewrites, or incompatible API changes.

When in doubt, bump minor. A "small feature" is still a feature.

## Design Principle: Thoughtful & Useful

This extension's identity is "thoughtful" — we prioritize presenting meaningful, well-organized information over shipping fast. Every UI element should help the user make better decisions.

- **Group by usefulness, not by data source.** Models are grouped by cost tier (Fast/Standard/Premium), not by vendor. The user cares about "how much does this cost me?" not "who made this model?"
- **Show decision-relevant data.** Multiplier badges tell users the cost implication of switching models. Don't hide information that affects their choices.
- **Don't become the Swiss Army knife.** Every feature we add should have a clear reason to exist and present its information thoughtfully. We are not a generic wrapper — we are a focused, opinionated tool.
- **Useful > Fast.** When choosing between shipping quickly and shipping something genuinely helpful, always choose helpful. A half-baked feature with missing context damages trust.

## Critical: Webview Build System

esbuild.js manually copies each webview file to `dist/`. When adding a new directory under `src/webview/app/`, you MUST update `esbuild.js` with:
1. A dist directory variable
2. An `mkdirSync()` call
3. A `copyFileSync()` call for each file

Without this, the webview silently fails (blank sidebar, no 'ready' message, no errors).

## Component Hierarchy (Do Not Violate)

MessageDisplay is a parent component that internally creates ToolExecution children. Never instantiate ToolExecution directly from main.js. The hierarchy:

```
main.js → SessionToolbar, MessageDisplay, AcceptanceControls, InputArea
MessageDisplay → ToolExecution (internal child)
InputArea → ActiveFileDisplay, StatusBar, PlanModeControls, SlashCommandPanel
```

## Testing Approach

This project uses strict TDD. Tests must import production code, not mocks. A test that passes immediately without failing first is not valid.

- Server-side tests (`tests/unit/extension/`) require `npm run compile-tests` first (compiles to `out/`).
- Webview tests use JSDOM (`tests/helpers/jsdom-setup.js`, `jsdom-component-setup.js`).
- Test helpers: `createTestDOM()`, `cleanupTestDOM()`, `createMockRpc()`, `createComponentDOM()`.
- E2E tests (`tests/e2e/`) need a live Copilot SDK connection and compiled output.

## SDK-First Development

The SDK source code lives at `research/copilot-sdk/*`. Before implementing any feature that touches the Copilot SDK (`sdkSessionManager.ts`, session lifecycle, model switching, tool registration, etc.):

1. **Read the SDK source first.** Check `research/copilot-sdk/nodejs/src/` for the proper API — types, RPC methods, session events. The SDK often has purpose-built methods for what you need (e.g., `session.rpc.model.switchTo()` instead of destroy/resume).
2. **Spike it.** Write a minimal script in `planning/spikes/<topic>/` that calls the SDK directly (no extension, no webview) to prove the behavior. See existing spikes for the pattern.
3. **Then implement.** Use what the spike proves, not assumptions about how the SDK works.

Key SDK reference files:

- `research/copilot-sdk/nodejs/src/client.ts` — CopilotClient (createSession, resumeSession, listModels)
- `research/copilot-sdk/nodejs/src/session.ts` — CopilotSession (sendAndWait, destroy, rpc accessor)
- `research/copilot-sdk/nodejs/src/generated/rpc.ts` — All RPC methods (session.model.switchTo, session.mode.get, etc.)
- `research/copilot-sdk/nodejs/src/generated/session-events.ts` — All session events (session.model_change, assistant.usage, etc.)
- `research/copilot-sdk/nodejs/src/types.ts` — SessionConfig, ResumeSessionConfig, ModelInfo

## Custom Tool Registration

Custom tools in plan mode must be registered in TWO places in sdkSessionManager.ts:
1. In `getCustomTools()` (the implementation)
2. In the `availableTools` array (the SDK whitelist)

## Session Files

Sessions stored at `~/.copilot/session-state/<session-id>/` containing `events.jsonl`, `plan.md`, `workspace.yaml`.
