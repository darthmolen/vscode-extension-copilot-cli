# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Branding

Do not add "written by Claude Code", "generated by Claude", "Co-Authored-By: Claude", or any AI attribution text to code, comments, commit messages, documentation, or any other output. The extension is built with Claude but branded as the user's own work.

## Build & Test Commands

```bash
npm run compile          # Type-check + lint + esbuild bundle
npm run watch            # Continuous rebuild (esbuild + tsc in parallel)
npm run package          # Production build (minified)
npm test                 # All unit + integration tests (~710 tests, Mocha + Chai)
npm run test:unit        # Unit tests only
npm run test:integration # Integration tests only
npm run check-types      # TypeScript type checking only
npm run lint             # ESLint on src/ (TypeScript only)
./test-extension.sh      # Build → package VSIX → uninstall old → install new
```

Run single test file: `npx mocha tests/unit/components/some-test.test.js --timeout 10000`

Known baseline failure: `main.js size constraint` in integration tests is expected and not a regression.

## Debugging

**F5 works.** The extension bundle has no `navigator` references, and the launch.json is correctly configured for `extensionHost`. Press F5 to launch the Extension Development Host. The preLaunchTask runs `npm run compile` (type-check + lint + esbuild).

For a faster dev loop, use `npm run watch` in a terminal and the VSIX workflow: `./test-extension.sh` then reload the window (`Ctrl+Shift+P` → "Developer: Reload Window").

Logs go to the "Copilot CLI" Output Channel (`Ctrl+Shift+U`).

## Architecture

This is a VS Code sidebar extension that wraps `@github/copilot-sdk` (backend-only, no UI) to provide a chat interface for GitHub Copilot CLI.

### Extension Host (TypeScript, `src/`)

- **extension.ts** — Orchestrator. Registers commands, creates ChatViewProvider, wires SDK events to webview.
- **sdkSessionManager.ts** — SDK session lifecycle. Creates/resumes CopilotClient sessions, streams messages, emits 10 granular events (onDidReceiveOutput, onDidStartTool, onDidProduceDiff, etc.).
- **chatViewProvider.ts** — Implements `WebviewViewProvider`. Manages ExtensionRpcRouter, slash command handlers, builds webview HTML. CSP config is at line ~494.
- **backendState.ts** — Singleton state store. Persists session data across webview recreations (sidebar hide/show).
- **src/extension/rpc/ExtensionRpcRouter.ts** — Type-safe RPC (18 send + 11 receive methods). Extension side of the message bridge.
- **src/extension/services/** — 7 extracted services: SessionService, InlineDiffService, FileSnapshotService, MCPConfigurationService, ModelCapabilitiesService, PlanModeToolsService, MessageEnhancementService.

### Webview (JavaScript ES modules, `src/webview/`)

The webview is plain JavaScript (not TypeScript, not bundled). Files are copied to `dist/` by esbuild.js.

- **main.js** — Bootstrap. Creates components, wires EventBus, registers RPC handlers.
- **app/rpc/WebviewRpcClient.js** — Webview-side RPC client using `acquireVsCodeApi()`.
- **app/state/EventBus.js** — Pub/sub for loose component coupling.
- **app/components/** — 9 components: MessageDisplay, ToolExecution, InputArea, SessionToolbar, AcceptanceControls, StatusBar, ActiveFileDisplay, PlanModeControls, SlashCommandPanel.
- **app/handlers/** — 5 handler modules for UI events, acceptance, messages, diffs, tool groups.

### Shared Types (`src/shared/`)

- **messages.ts** — 31 RPC message type definitions (the contract between extension and webview).
- **models.ts** — Domain types (Session, Message, ToolState, PlanModeStatus).

### Data Flow

```
User types message → InputArea → EventBus → main.js → WebviewRpcClient._send()
  → postMessage → ExtensionRpcRouter handler → SDKSessionManager.sendMessage()
  → Copilot SDK → CLI backend

CLI responds → SDK event → SDKSessionManager emitter
  → ChatViewProvider handler → ExtensionRpcRouter.send*()
  → postMessage → WebviewRpcClient handler → EventBus.emit() → Components update DOM
```

### Key Patterns

- **BufferedEmitter** (`src/utilities/bufferedEmitter.ts`): Queues events if webview isn't ready; replays on connect. Prevents lost messages during startup.
- **DisposableStore** (`src/utilities/disposable.ts`): Centralized cleanup for subscriptions.
- **Dual-session plan mode**: Work session + plan session. Plan session writes to work session's `plan.md`. Plan mode restricts tool access (no write/commit/install).

## Versioning (Semver)

- **Patch** (3.1.x): Bug fixes and minor changes. No new features, no new UI, no new APIs. Small behavior improvements (e.g., smarter fallback logic) that don't add capabilities are patch-level.
- **Minor** (3.x.0): New features, new capabilities, new UI elements. Image support, mermaid rendering, model switching — these are all minor bumps.
- **Major** (x.0.0): Breaking changes, architectural rewrites, or incompatible API changes.

When in doubt, bump minor. A "small feature" is still a feature.

## Critical: Webview Build System

esbuild.js manually copies each webview file to `dist/`. When adding a new directory under `src/webview/app/`, you MUST update `esbuild.js` with:
1. A dist directory variable
2. An `mkdirSync()` call
3. A `copyFileSync()` call for each file

Without this, the webview silently fails (blank sidebar, no 'ready' message, no errors).

## Component Hierarchy (Do Not Violate)

MessageDisplay is a parent component that internally creates ToolExecution children. Never instantiate ToolExecution directly from main.js. The hierarchy:

```
main.js → SessionToolbar, MessageDisplay, AcceptanceControls, InputArea
MessageDisplay → ToolExecution (internal child)
InputArea → ActiveFileDisplay, StatusBar, PlanModeControls, SlashCommandPanel
```

## Testing Approach

This project uses strict TDD. Tests must import production code, not mocks. A test that passes immediately without failing first is not valid.

- Server-side tests (`tests/unit/extension/`) require `npm run compile-tests` first (compiles to `out/`).
- Webview tests use JSDOM (`tests/helpers/jsdom-setup.js`, `jsdom-component-setup.js`).
- Test helpers: `createTestDOM()`, `cleanupTestDOM()`, `createMockRpc()`, `createComponentDOM()`.
- E2E tests (`tests/e2e/`) need a live Copilot SDK connection and compiled output.

## Custom Tool Registration

Custom tools in plan mode must be registered in TWO places in sdkSessionManager.ts:
1. In `getCustomTools()` (the implementation)
2. In the `availableTools` array (the SDK whitelist)

## Session Files

Sessions stored at `~/.copilot/session-state/<session-id>/` containing `events.jsonl`, `plan.md`, `workspace.yaml`.
